---
layout: post
title:  "[BigQuery] PIVOT operator"
subtitle: "[BigQuery] PIVOT operator"
categories: gcp
tags: bigquery
comments: true
---

####  Contents
- [PIVOT operatorì˜ ê¸°ë³¸í˜•íƒœ](#PIVOT-operatorì˜-ê¸°ë³¸í˜•íƒœ)
- [PIVOT operator ì˜ˆì‹œ](#PIVOT-operator-ì˜ˆì‹œ)
- [PIVOT operator í™œìš©í•˜ê¸°](#PIVOT-operator-í™œìš©í•˜ê¸°)
	- [ë§Œì•½ ê·¸ë£¹ë³„ë¡œ ë‚˜ëˆ„ì–´ì„œ ë³´ê³ ìí•˜ëŠ” ì¼€ì´ìŠ¤ê°€ 2ì¢…ë¥˜ì¼ ê²½ìš°](#ë§Œì•½-ê·¸ë£¹ë³„ë¡œ-ë‚˜ëˆ„ì–´ì„œ-ë³´ê³ ìí•˜ëŠ”-ì¼€ì´ìŠ¤ê°€-2ì¢…ë¥˜ì¼-ê²½ìš°)
	- [Dynamically generating pivot column values](#Dynamically-generating-pivot-column-values)

<br>

ë³¸ í¬ìŠ¤íŒ…ì€ Bigqueryì˜ PIVOT OPERATORì— ê´€í•œ ë‚´ìš©ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

---

<br>

ì˜¤ëœë§Œì— Google Cloud ì¶œì‹œ ë…¸íŠ¸ë¥¼ í™•ì¸í•˜ë˜ ì¤‘ Bigqueryë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ëŒì´ë¼ë©´ ê°€ìŠ´ì„ ë‘ê·¼ê±°ë¦¬ê²Œ ë§Œë“œëŠ” ê¸°ëŠ¥ì´ 2021ë…„ 5ì›” 10ì¼ì— í…ŒìŠ¤íŠ¸ë¡œ ì¶œì‹œëœ ê²ƒì„ í™•ì¸í•˜ì˜€ë‹¤!  

<br>

ê·¸ OperatorëŠ” ORACLEì—ì„œëŠ” í”í•˜ê²Œ ë³´ê³  ì“¸ ìˆ˜ ìˆì§€ë§Œ, Biguqeryì—ì„œëŠ” "ì™œ ì´ê²Œ ì—†ì§€? ğŸ¤”"ë¥¼ ë§¤ë²ˆ ìƒê°í•˜ê²Œ ë§Œë“¤ì—ˆë˜  `PIVOT Operator`ì´ë‹¤. ì‹¬ì§€ì–´ `UNPIVOT`ë„ ê°™ì´ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `UNPIVOT`ì˜ ê²½ìš°ëŠ” 2020ë…„ì— ì¶”ê°€ëœ `fhoffa.x.unpivot()`ìœ¼ë¡œë„ ëŒ€ì²´í•  ìˆ˜ ìˆì§€ë§Œ ë­”ê°€ ì„¸íŠ¸ë©”ë‰´ì²˜ëŸ¼ ë‚˜ì˜¨ê²Œ ê°ê²©ìŠ¤ëŸ¬ì› ë‹¤.  ë”ë¶ˆì–´, QUALIFYë¼ëŠ” Operatorë„ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆëŠ”ë° ì´ ë˜í•œ ì‚¬ìš©ìì˜ í¸ì˜ì„±ì„ ë†’ì—¬ì£¼ëŠ” Operatorì˜€ì—ˆë‹¤. ì°¨í›„ì— ì´ê²ƒì— ê´€í•´ì„œë„ ë¸”ë¡œê·¸ì— ì •ë¦¬í•´ë³¼ ì˜ˆì •ì´ë‹¤. (ë‹¨ì§€, í•œ ê°€ì§€ ì´ ê¸°ëŠ¥ë“¤ì— ê´€í•´ì„œ ë¶ˆì•ˆí•œ ì ì€ Preview Versionì´ë¼ëŠ” ì ì´ë‹¤....ğŸ˜•) 


![2](https://user-images.githubusercontent.com/53929665/120649430-b7676d00-c4b7-11eb-993b-743e1bed39ed.JPG)

<br>

ì´ì œ ì•„ë¬´ë§ ëŒ€ì”ì¹˜ì˜€ë˜ ì„œë¡ ì€ ëë‚´ê³  ìƒˆë¡œ ì¶œì‹œëœ `PIVOT` Operatorì— ê´€í•˜ì—¬ ì•Œì•„ë³´ì. 

<br>

--- 

### PIVOT operatorì˜ ê¸°ë³¸í˜•íƒœ

ë‹¤ìŒì€ Bigquery Documentsì—ì„œ ì œì‹œí•˜ëŠ” ê¸°ë³¸ í¬ë§·ì´ë‹¤. 

``` SQL

FROM  from_item[,  ...]  pivot_operator  
  
pivot_operator: PIVOT(  aggregate_function_call  [as_alias][,  ...]  FOR  input_column  IN  (  pivot_column  [as_alias][,  ...]  )  )  [AS  alias]  
  
as_alias:  [AS]  alias

```

í¬ë§·ë§Œ ë³´ì•˜ì„ ë•Œ, ê°€ì¥ ëˆˆì— ë„ëŠ” ì ì€ ì•„ë˜ì™€ ê°™ì•˜ë‹¤.
- `PIVOT`operatorê°€ `FROM` ì ˆì˜ ì¼ë¶€ë¶„ìœ¼ë¡œ ëª…ì‹œëœ í…Œì´ë¸” ë’¤ì—  ì‚¬ìš©í•œë‹¤ëŠ” ì 
- ì¤‘ê°„ ì¤‘ê°„ì— ë³„ì¹­(alias)ì„ ëª…ì‹œ í•  ìˆ˜ ìˆë‹¤ëŠ” ì 
- ì§‘ê³„ í•¨ìˆ˜(aggregate_function) ê°€ ì‚¬ìš©ë˜ì–´ì§„ë‹¤ëŠ” ì 

<br>

ê·¸ë¦¬ê³ ,  ê° ì£¼ìš” ë³€ìˆ˜ë“¤ì„ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ë˜ì–´ì§„ë‹¤. 
```SQL
PIVOT( {aggregate_function_call}  FOR {input_column} IN({pivot_column}))
```
- `input_column` :  c olumnìœ¼ë¡œ ì˜®ê¸°ê³ ì(ì¦‰, Pivotí•˜ê³ ì)í•˜ëŠ” row ë°ì´í„°ë¥¼ ê°€ì§„ column
- `pivot_column` : ì§‘ê³„í•¨ìˆ˜ë¥¼ í†µí•´ pivot columnìœ¼ë¡œ ë³€í™˜ë˜ì–´ì§ˆ input columnì˜ rowë°ì´í„°  
- `aggregate_function_call` :  input columnì„ ì§‘ê³„í•˜ê¸°ìœ„í•´ í˜¸ì¶œë˜ì–´ì§€ëŠ” ì§‘ê³„í•¨ìˆ˜

<br>

ë‹¤ìŒìœ¼ë¡œ pivot ê¸°ëŠ¥ì„ ì˜ˆì‹œë¥¼ í†µí•˜ì—¬ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì.

<br>

--- 

### PIVOT operator ì˜ˆì‹œ

*ë‹¤ìŒì€ Bigqueryì—ì„œ Publicìœ¼ë¡œ ê³µê°œí•˜ëŠ” `london_bicycles` ë°ì´í„°ì…‹ì˜ `cycle_hire`í…Œì´ë¸”ì„ ì´ìš©í•œ ì˜ˆì‹œì´ë‹¤.

ê° í•„ë“œëŠ” ë‹¤ìŒì„ ì˜ë¯¸í•œë‹¤ê³  ê°€ì •í•  ê²ƒì´ë‹¤.
- bike_id : ìì „ê±° ê³ ìœ  ë²ˆí˜¸
- start_date : ìì „ê±° ëŒ€ì—¬ ì‹œê°„
- end_date : ìì „ê±° ë°˜ë‚© ì‹œê°„
- duration : ìì „ê±° ëŒ€ì—¬ ì‹œê°„ (end_date - start_date, unit is sec)
- start_station_name : ìì „ê±° ëŒ€ì—¬í•œ ìŠ¤í…Œì´ì…˜ ìœ„ì¹˜
- end_station_name : ìì „ê±°ë¥¼ ë°˜ë‚©í•œ ìŠ¤í…Œì´ì…˜ ìœ„ì¹˜

![3](https://user-images.githubusercontent.com/53929665/120658195-2fd22c00-c4c0-11eb-8730-08dc1ad62443.JPG)

<br>

í•´ë‹¹ ë°ì´í„°ë¥¼ í†µí•´,  Queen Street 2, Bankì˜ ìì „ê±° ìŠ¤í…Œì´ì…˜ì—ì„œ ê° end_stationê¹Œì§€ ê±¸ë¦° ì´ìš©ì‹œê°„ì˜ ì¼ë³„ í‰ê· ì„ êµ¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì„ ê²ƒì´ë‹¤. í•˜ì§€ë§Œ, ì§‘ê³„ë˜ì–´ì§€ëŠ” í–‰ ìˆ˜ëŠ” ë¬´ë ¤35950ê°œì´ë‹¤. ì´ëŠ” ê°€ë…ì„±ì´ ë–¨ì–´ì§ˆ ë¿ ë§Œ ì•„ë‹ˆë¼, ì¤‘ìš” ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ê¸°ì—ëŠ” íš¨ê³¼ì ì´ì§€ ì•Šìœ¼ë©°, Redashë‚˜ Data Studioë¥¼ í†µí•´ ë°ì´í„°ë¥¼  ì‹œê°í™”í•˜ê¸° ë¶ˆí¸í•œë‹¤. ë”°ë¼ì„œ, PIVOT ì‹œí‚¬ í•„ìš”ê°€ ìˆë‹¤.

![4](https://user-images.githubusercontent.com/53929665/120660856-ba1b8f80-c4c2-11eb-96ad-57fa265058cf.JPG)

<br>

PIVOT Operatorê°€ ì—†ë˜ ì‹œì ˆ(ë¼ë–¼ëŠ” ë§ì´ì•¼... â˜•)ì—ëŠ”  `MAX`(í˜¹ì€ ë‹¤ë¥¸ ì§‘ê³„í•¨ìˆ˜)ì™€ `IF`ë¥¼ ì´ìš©í•´ì„œ Pivot Columnìœ¼ë¡œ ìƒì„±í•˜ê³ ìí•˜ëŠ” ì—´ì˜ ê°’ë“¤ì„ í•˜ë‚˜ í•˜ë‚˜ ì—´ê±° í–ˆì„ ê²ƒì´ë‹¤([ì°¸ì¡°ë§í¬](https://corecompete.com/how-to-build-pivot-tables-in-bigquery-fast-and-easy/)).  í•˜ì§€ë§Œ, PIVOTí•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤.  í•˜ì§€ë§Œ, ì•„ë˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë“¯ì´ PIVOT Columnë“¤ì„ ì—´ê±°í•´ì•¼í•œë‹¤ëŠ” ë¶ˆí¸í•¨ì€ ì˜¨ì „í•˜ì˜€ë‹¤... ğŸ˜… 


![5](https://user-images.githubusercontent.com/53929665/120664413-dd940980-c4c5-11eb-8774-2cb1faa2fd28.JPG)

<br>

ë”ë¶ˆì–´, ë³´í†µì˜ ì¿¼ë¦¬ë“¤ê³¼ ë™ì¼í•˜ê²Œ  `WHERE`ê³¼ `ORDER BY`ì ˆì„ ì´ìš©í•˜ì—¬  `PIVOT`ìœ¼ë¡œ ì¸í•˜ì—¬ ì§‘ê³„ëœ columnì— í•„í„°ë¥¼ ë§Œë“¤ê±°ë‚˜ ì˜¤ë¦„ì°¨ìˆœì´ë‚˜ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œë„ ì •ë ¬ì„ í•´ì¤„ ìˆ˜ë„ ìˆë‹¤.

![6](https://user-images.githubusercontent.com/53929665/120666370-7f682600-c4c7-11eb-8e05-da7e500426df.JPG)

<br>

ë‹¤ìŒì€ í•´ë‹¹ operatorë¥¼ ì¡°ê¸ˆ ë” ìœ ìš©í•˜ê²Œ í™œìš©í•  ëª‡ê°€ì§€ ë°©ë²•ì— ê´€í•˜ì—¬ ì•Œì•„ë³´ì.

<br>

---

### PIVOT operator í™œìš©í•˜ê¸°

#### ë§Œì•½ ê·¸ë£¹ë³„ë¡œ ë‚˜ëˆ„ì–´ì„œ ë³´ê³ ìí•˜ëŠ” ì¼€ì´ìŠ¤ê°€ 2ì¢…ë¥˜ì¼ ê²½ìš°

ìœ„ì˜ ì‚¬ìš© ì˜ˆì œì—ì„œëŠ”  Queen Street 2, Bankì˜ ìì „ê±° ìŠ¤í…Œì´ì…˜ì—ì„œ ì‹œì‘í•˜ëŠ” ì¼€ì´ìŠ¤ë§Œ í™•ì¸í•˜ì˜€ë‹¤. í•˜ì§€ë§Œ, ë§Œì•½ Queen Street 1, Bankê³¼ Waterloo Station 3, Waterlooë„ ê°™ì´ í™•ì¸í•˜ê³  ì´ë“¤ì„ `PIVOT` operatorë¥¼ ì´ìš©í•´ì„œ í”¼ë²—í•˜ê³  ì‹¶ì„ ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œí•˜ë©´ ì¢‹ì„ê¹Œ?

ì¿¼ë¦¬ë¡œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê° start_stationë³„ë¡œ AVGì§‘ê³„ë¥¼ ì§„í–‰í•œë‹¤.
``` SQL
SELECT  DATE(start_date)  AS start_date, end_station_name,
		AVG(IF(start_station_name = 'Queen Street 2, Bank', duration, NULL))  AS avg_duration_for_street2,
		AVG(IF(start_station_name = 'Queen Street 1, Bank', duration, NULL))  AS avg_duration_for_stree1,
		AVG(IF(start_station_name = 'Waterloo Station 3, Waterloo', duration, NULL))  AS avg_duration_for_Waterloo

FROM  `bigquery-public-data.london_bicycles.cycle_hire`
WHERE start_station_name IN('Queen Street 2, Bank', 'Queen Street 1, Bank', 'Waterloo Station 3, Waterloo')
GROUP  BY  1, 2
```
ì¶œë ¥ëœ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

![7](https://user-images.githubusercontent.com/53929665/120669491-79277900-c4ca-11eb-869c-e9295f411c75.JPG)


<br>

ê·¸ë¦¬ê³ , ì´ ìƒí™©ì—ì„œ pivot columnìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ ìƒì„±í•˜ê³ ì í•œë‹¤.

- Waterloo Station 3, Waterlooì— ëŒ€í•´ì„œ 
	-  waterloo_2017_06_01
	-  waterloo_2017_06_02
	-  waterloo_2017_06_03
- Queen Street 1, Bankì— ëŒ€í•´ì„œ 
	-  street1_2017_06_01
	-  street1_2017_06_02
	-  street1_2017_06_03
- Queen Street 2, Bankì— ëŒ€í•´ì„œ 
	-  street2_2017_06_01
	-  street2_2017_06_02
	-  street2_2017_06_03

<br>

ì´ ê²½ìš°ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ ì§‘ê³„í•¨ìˆ˜ì™€ aliasë¥¼ ì ì ˆí•˜ê²Œ ì´ìš©í•˜ë©´ ì‰½ê²Œ í‘œí˜„ê°€ëŠ¥í•˜ë‹¤.
```SQL
SELECT  *
FROM temp0
PIVOT(	
		MAX(avg_duration_for_Waterloo)  AS waterloo,
		MAX(avg_duration_for_stree1)  AS street1,
		MAX(avg_duration_for_street2)  AS street2
		FOR start_date IN('2017-06-01', '2017-06-02', '2017-06-03')
	 )
WHERE waterloo_2017_06_01 IS  NOT  NULL
```

ì•„ë˜ì˜ ê²°ê³¼ë¥¼ í†µí•´ ê³„íš í–ˆë˜ pivot columnë“¤ì´ ëª¨ë‘ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. 

![8](https://user-images.githubusercontent.com/53929665/120670104-0bc81800-c4cb-11eb-9419-97281e58a45e.JPG)

ì´ëŠ” ë‹¨ìˆœíˆ ìœ„ì—ì„œ ì–¸ê¸‰í–ˆë˜ `AVG(IF...)`ë¥¼ 9ë²ˆ ì—´ê±°í•´ì„œ ìœ„ì™€ ê°™ì´ êµ¬ì„±í•  ìˆ˜ ìˆì§€ë§Œ, ë§Œì•½ í‘œí˜„í•˜ê³ ìí•˜ëŠ” í•„ë“œ ìˆ˜ê°€ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ë§ì•„ì§ˆ ê²½ìš° ê°œì¸ì ìœ¼ë¡œëŠ” í•´ë‹¹ ë°©ë²•ì´ ë” ì‹¬ë¦¬ì ìœ¼ë¡œë‚˜ ì‹œê°ì ìœ¼ë¡œë‚˜ ê°œì¸ì ìœ¼ë¡œ ë” ë‚˜ì•˜ë‹¤. 

<br>

#### Dynamically generating pivot column values

`PIVOT` Operatorê°€ í¸ë¦¬í•œ ê²ƒ ê°™ì•„ ë³´ì´ì§€ë§Œ,  pivot ì‹œí‚¤ê³ ìí•˜ëŠ” columnì´ ë§ì•„ì§ˆìˆ˜ë¡  `IN(  )`ì•ˆì— ê¸°ì…í•´ì•¼í•  pivot_columnë„ ë¹„ë¡€í•˜ì—¬ ëŠ˜ì–´ë‚œë‹¤.  ë”ë¶ˆì–´,  `IN( )`ì•ˆì—  `SELECT`ì ˆ, `ARRAY`ë“±ì„ ê¸°ì…í•  ìˆ˜ ì—†ë‹¤.  

<br>

ì´ëŸ¬í•œ  ë¶ˆí¸í•¨ì„ ì¡°ê¸ˆì´ë¼ë„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ë‹¤ìŒì˜ [Mediumë§í¬](https://towardsdatascience.com/how-to-use-dynamic-sql-in-bigquery-8c04dcc0f0de)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

<br>

ì´ ë°©ë²•ì˜ í•µì‹¬ì€ `EXECUTE IMMEDIATE`ì´ë‹¤.

``` SQL
DECLARE duration_range STRING;
SET  duration_range =
(
	SELECT  CONCAT('(', ARRAY_TO_STRING(ARRAY_AGG(CONCAT('"',CAST(duration AS  STRING), '"')), ', '), ')')
	FROM  UNNEST(GENERATE_DATE_ARRAY('2017-06-01', '2017-06-03'))  AS duration
);

  
EXECUTE  IMMEDIATE  format("""

	WITH temp0 AS
	(
		SELECT  DATE(start_date)  AS start_date, end_station_name, AVG(duration)  AS avg_duration
		FROM  `bigquery-public-data.london_bicycles.cycle_hire`
		WHERE  start_station_name = 'Waterloo Station 3, Waterloo'
		GROUP  BY  1, 2
	)

	SELECT  *

	FROM temp0
	PIVOT(MAX(avg_duration) FOR start_date IN  %s)

""", duration_range);

```

<br>

í•´ë‹¹ ë°©ë²•ì— ê´€í•´ì„œëŠ” ì•„ì§ ê°œì¸ì ìœ¼ë¡œ í™•ì‹¤í•˜ì§€ ì•Šì€ ê²ƒë„ ë§ìœ¼ë©° ì´í•´ë˜ì§€ ì•ŠëŠ” ê²ƒë„ ë§ë‹¤. ë”°ë¼ì„œ,  `PIVOT`ì„ ë” ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ ìŠ¤í¬ë¦½íŒ…ë¬¸ì— ê´€í•´ì„œ ë” ê³µë¶€í•  í•„ìš”ê°€ ìˆì–´ë³´ì¸ë‹¤ ğŸ¤”

<br>

---

### References

- [CORECOMPETE, A Fast Approach to Building Pivot Table / Transpose Functionality into BigQuery](https://corecompete.com/how-to-build-pivot-tables-in-bigquery-fast-and-easy/)
- [BigQuery Pivot Document](https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#rules_for_pivot_agg_function)
- [BigQuery Scripting statements](https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting#execute_immediate)
- [towardsdatascience, PIVOT in Bigquery](https://towardsdatascience.com/pivot-in-bigquery-4eefde28b3be)
- [towardsdatascience, How to use Dynamic SQL in BigQuery](https://towardsdatascience.com/how-to-use-dynamic-sql-in-bigquery-8c04dcc0f0de)


